<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    {{ partial "head.html" . }}
  </head>
  <body
    x-data="menu()"
    x-init="fetchMenuData"
    class="bg-christmas-cream-light min-h-screen"
  >
    {{ partial "header.html" . }} {{ block "main" . }}{{ end }} {{ partial
    "footer.html" . }}

    <dialog id="errorModal" class="modal">
      <div class="modal-box bg-christmas-cream-light border border-christmas-gold/30">
        <h3 class="font-bold text-lg text-christmas-burgundy-dark font-serif">Oops!</h3>
        <p id="modalMessage" class="py-4 text-christmas-green-dark"></p>
        <div class="modal-action">
          <form method="dialog">
            <button
              class="btn bg-christmas-burgundy text-christmas-cream-light hover:bg-christmas-burgundy-dark border-0"
            >
              Close
            </button>
          </form>
        </div>
      </div>
    </dialog>

    <script>
      function menu() {
        return {
          product: null,
          selectedVariant: 1, // Default to 500g (index 1)
          quantities: [0, 0, 0], // Quantities for each variant
          customerName: "",

          fetchMenuData() {
            const data = {{ .Site.Data.chocolates | jsonify | safeJS }};
            this.product = data.product;
          },

          get cartItems() {
            if (!this.product) return [];
            return this.product.variants
              .map((variant, index) => ({
                ...variant,
                quantity: this.quantities[index]
              }))
              .filter(item => item.quantity > 0);
          },

          get cartTotal() {
            return this.cartItems.reduce(
              (total, item) => total + item.price * item.quantity,
              0
            );
          },

          sendWhatsAppOrder() {
            const showModal = (message) => {
              document.getElementById("modalMessage").textContent = message;
              errorModal.showModal();
            };

            if (!this.customerName) {
              showModal('Please enter your name.');
              return;
            }

            if (this.cartItems.length === 0) {
              showModal('Your cart is empty. Please select a quantity before placing an order.');
              return;
            }

            let message = `Hi!\n\nI'm ${this.customerName}, and I'd love to order your Christmas Plum Cake.\n\n`;
            message += `*Order Details:*\n`;
            this.cartItems.forEach(item => {
              message += `â€¢ ${item.label} (${item.size}) x ${item.quantity} - Rs.${item.price * item.quantity}\n`;
            });
            message += `\n*Total: Rs.${this.cartTotal}*`;
            message += `\n\nKindly confirm availability and share payment details. Thank you!`;

            const encodedMessage = encodeURIComponent(message);
            window.open(`https://wa.me/918700022184?text=${encodedMessage}`, '_blank');
          }
        };
      }
    </script>
  </body>
</html>
